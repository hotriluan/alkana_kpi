{% extends 'kpi_app/portal/base.html' %}
{% load static %}

{% block content %}
<div class="row mb-4 fade-in-up">
    <div class="col-12 text-center text-md-start d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div>
            <h2 class="fw-bold mb-1">Manager Overview</h2>
            <p class="text-secondary mb-0">KPI Performance & Anomaly Detection Center</p>
        </div>

        <!-- Filter Form -->
        <form method="get" class="d-flex align-items-center gap-2">
            <select name="year" class="form-select form-select-sm glass-input" onchange="this.form.submit()">
                {% for y in filters.year_options %}
                <option value="{{ y.value }}" {% if y.selected %}selected{% endif %}>{{ y.label }}</option>
                {% endfor %}
            </select>
            <select name="semester" class="form-select form-select-sm glass-input" onchange="this.form.submit()">
                {% for s in filters.sem_options %}
                <option value="{{ s.value }}" {% if s.selected %}selected{% endif %}>{{ s.label }}</option>
                {% endfor %}
            </select>
            <select name="month" class="form-select form-select-sm glass-input" onchange="this.form.submit()">
                {% for m in filters.month_options %}
                <option value="{{ m.value }}" {% if m.selected %}selected{% endif %}>{{ m.label }}</option>
                {% endfor %}
            </select>
        </form>
    </div>
</div>

<!-- Stats Row -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="glass-card stat-card p-4 h-100">
            <div class="icon-box bg-primary bg-opacity-10 text-primary mb-3">
                <i class="bi bi-people-fill fs-4"></i>
            </div>
            <h6 class="text-uppercase text-secondary small fw-bold">Total Staff</h6>
            <h3 class="fw-bold mb-0">{{ stats.total_staff }}</h3>
            <span class="text-xs text-muted">Active Employees</span>
        </div>
    </div>
    <div class="col-md-3">
        <div class="glass-card stat-card p-4 h-100">
            <div class="icon-box bg-success bg-opacity-10 text-success mb-3">
                <i class="bi bi-check-all fs-4"></i>
            </div>
            <h6 class="text-uppercase text-secondary small fw-bold">Completed</h6>
            <h3 class="fw-bold mb-0">{{ stats.done }}</h3>
            <span class="text-xs text-success">
                <i class="bi bi-graph-up-arrow"></i> {{ stats.completion_rate }}% Rate
            </span>
        </div>
    </div>
    <div class="col-md-3">
        <div class="glass-card stat-card p-4 h-100">
            <div class="icon-box bg-warning bg-opacity-10 text-warning mb-3">
                <i class="bi bi-clock-history fs-4"></i>
            </div>
            <h6 class="text-uppercase text-secondary small fw-bold">Pending Review</h6>
            <h3 class="fw-bold mb-0">{{ stats.pending }}</h3>
            <span class="text-xs text-muted">Action Required</span>
        </div>
    </div>
    <div class="col-md-3">
        <div class="glass-card stat-card p-4 h-100">
            <div class="icon-box bg-purple bg-opacity-10 text-purple mb-3">
                <i class="bi bi-speedometer2 fs-4"></i>
            </div>
            <h6 class="text-uppercase text-secondary small fw-bold">Avg Score</h6>
            <h3 class="fw-bold mb-0">{{ stats.avg_score }}</h3>
            <span class="text-xs text-muted">Department Wide</span>
        </div>
    </div>
</div>

<!-- Charts & Anomalies -->
<div class="row g-4 mb-4">
    <!-- Chart Section -->
    <div class="col-lg-5">
        <div class="glass-card p-4 h-100">
            <h5 class="fw-bold mb-4">Completion Status</h5>
            <div style="height: 300px; position: relative;">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Anomalies Section -->
    <div class="col-lg-7">
        <div class="glass-card p-4 h-100">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="fw-bold text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>Attention Needed
                    (Outliers)</h5>
                <span class="badge bg-danger bg-opacity-10 text-danger">{{ anomalies.count }} Issues</span>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="text-secondary small text-uppercase bg-light">
                        <tr>
                            <th scope="col" style="width: 15%">Alert Type</th>
                            <th scope="col" style="width: 20%">Employee</th>
                            <th scope="col" style="width: 25%">KPI Name</th>
                            <th scope="col" style="width: 20%">The Math</th>
                            <th scope="col" class="text-end" style="width: 10%">Score</th>
                            <th scope="col" class="text-end" style="width: 10%">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in anomalies %}
                        <tr>
                            <td>
                                {% if item.final_result > 10.0 %}
                                <span class="badge bg-danger rounded-pill"><i
                                        class="bi bi-exclamation-octagon me-1"></i>Typo?</span>
                                {% elif item.final_result < 0.3 %} <span
                                    class="badge bg-warning text-dark rounded-pill"><i
                                        class="bi bi-graph-down-arrow me-1"></i>Low Perf</span>
                                    {% else %}
                                    <span class="badge bg-info text-dark rounded-pill"><i
                                            class="bi bi-search me-1"></i>Review</span>
                                    {% endif %}
                            </td>
                            <td>
                                <div class="fw-bold text-dark">{{ item.employee.name }}</div>
                                <div class="small text-muted">{{ item.employee.user_id.username }}</div>
                            </td>
                            <td>
                                <div class="text-wrap" style="max-width: 200px;" title="{{ item.kpi.kpi_name }}">
                                    {{ item.kpi.kpi_name }}
                                </div>
                            </td>
                            <td>
                                <div class="d-flex flex-column" style="font-size: 0.85rem;">
                                    <div class="d-flex justify-content-between">
                                        <span class="text-muted me-2">Target:</span>
                                        <span class="fw-bold text-dark">{{ item.display_target_set }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span class="text-muted me-2">Actual:</span>
                                        <span class="fw-bold text-dark">{{ item.display_achivement }}</span>
                                    </div>
                                </div>
                            </td>
                            <td class="text-end">
                                <span
                                    class="fw-bold {% if item.final_result > 1.25 %}text-danger{% elif item.final_result < 0.5 %}text-warning{% endif %}">
                                    {{ item.display_final_result }}
                                </span>
                            </td>
                            <td class="text-end">
                                <a href="{% url 'admin:kpi_app_alk_kpi_result_change' item.id %}" target="_blank"
                                    class="btn btn-sm btn-outline-primary rounded-pill px-3">
                                    View
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center py-5 text-muted">
                                <div class="mb-3">
                                    <i class="bi bi-check-circle-fill fs-1 text-success opacity-25"></i>
                                </div>
                                <h6 class="fw-bold">No Issues Found</h6>
                                <p class="small mb-0">All KPIs are performing within normal ranges.</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Chart Config -->
{{ stats.done|json_script:"done-data" }}
{{ stats.pending|json_script:"pending-data" }}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const done = JSON.parse(document.getElementById('done-data').textContent);
        const pending = JSON.parse(document.getElementById('pending-data').textContent);

        const ctx = document.getElementById('statusChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Completed', 'Pending'],
                datasets: [{
                    data: [done, pending],
                    backgroundColor: [
                        'rgba(25, 135, 84, 0.8)', // Success Green
                        'rgba(255, 193, 7, 0.8)'  // Warning Yellow
                    ],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    });
</script>
{% endblock %}